<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="styles.css">

    <title>Play games</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  </head>

  <body id="body">
    <div class="dropdown" id="dropdownButton">
      <button
        class="btn btn-secondary btn-lg dropdown-toggle"
        type="button"
        id="dropdownMenuButton"
        data-toggle="dropdown"
        aria-haspopup="true"
        aria-expanded="false"
      >
        Dropdown button
      </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        <a
          class="dropdown-item"
          id="RockPaperScissorsButton"
          onclick="RockPaperScissors()"
          href="#"
          >Rock paper scissors</a
        >
        <a class="dropdown-item" onclick="TicTacToe()" href="#">Tic-Tac-Toe</a>
        <a class="dropdown-item" onclick="marioDisplay()" href="#">Mario</a>
      </div>
    </div>

    <div id="RockPaperScissors">
      <div>
        "What's your choice? 'r' for rock, 'p' for paper, 's' for scissors
      </div>
      <br />
      <input type="text" id="rock-paper-scissors-input" />
      <button type="button" id="button">Play rock-paper-scissors</button>
      <br />
      <br />
      <div id="result"></div>
    </div>

    <div id="TicTacToe">
      <button type="button" id="button-tic-tac-toe">Play again</button>
      <br />
      <br />
      <div>
        This are the positions, please choose where you want to add your piece
      </div>
      <div id="tic-tac-toe-rules"></div>
      <br />
      <h4>Current game</h4>
      <br />
      <div id="tic-tac-toe-result"></div>
      <input type="text" id="tic-tac-toe-input" />
      <button type="button" id="Submit-square-tic-tac-toe">
        Submit square
      </button>
    </div>


    <py-script src="my_script.py">
      from js import setTimeout, requestAnimationFrame, player
      from pyodide import create_once_callable
      import asyncio
      
      context = canvas.element.getContext("2d")
      
      isVideo = False
      model = None
      last_position = 0
      direction = "stop"
      
      modelParams = {
        "flipHorizontal": True, # flip e.g for video
        "maxNumBoxes": 20, # maximum number of boxes to detect
        "iouThreshold": 0.5, # ioU threshold for non-max suppression
        "scoreThreshold": 0.6, # confidence threshold for predictions.
      }
      
      def toggle_video(evt):
        global isVideo
        player.jump()
      
        if (not isVideo):
          update_note.write("Starting video")
          pyscript.run_until_complete(start_video())
        else:
          update_note.write("Stopping video")
          isVideo = False
          update_note.write("Video stopped")
      
      async def start_video():
        global isVideo
        update_note.write("Inside start video")
        console.log("video started", status)
        if status:
          update_note.write("Video started. Now tracking")
          isVideo = True
          console.log( "Calling RUN DETECTION")
          y = await run_detection()
        else:
          update_note.write( "Please enable video")
      
      def sync_run_detection(evt):
        pyscript.run_until_complete(run_detection())
      
      async def run_detection():
        global model
        global isVideo
        global last_position
        global direction
      
        predictions = await model.detect(video.element)
        model.renderPredictions(predictions, canvas.element, context, video.element);
      
        if predictions:
          curr_position = predictions[0].bbox[0] + (predictions[0].bbox[2] / 2)
          delta = last_position - curr_position
          last_position = curr_position
          #console.log(delta, curr_position, last_position)
          if abs(delta) < 2:
            direction = "stop"
          elif delta > 0:
            direction = "left"
          else:
            direction = "right"
      
          for prediction in predictions:
            if prediction.label == 'open':
              player.jump()
            elif prediction.label == 'close':
              player.crouch()
      
        if (isVideo):
          await requestAnimationFrame(create_once_callable(sync_run_detection));
      
      def handle_model(lmodel):
        global model
        model = lmodel
        update_note.write("Loaded Model!")
      
      async def start():
        handle_model(model)
      
      pyscript.run_until_complete(start())      
      
    </py-script>

    <div class="mb10" id="mario">
      <p>Use ← or →  to move, ↓ to crouch and x to jump. If video is enabled, say hi to jump as well! </p>
    </div>

    <script type="text/javascript" src="js/util.js"></script>
    <script type="text/javascript" src="js/input.js"></script>
    <script type="text/javascript" src="js/resources.js"></script>
    <script type="text/javascript" src="js/sprite.js"></script>
    <script type="text/javascript" src="js/entity.js"></script>
    <script type="text/javascript" src="js/pipe.js"></script>
    <script type="text/javascript" src="js/mushroom.js"></script>
    <script type="text/javascript" src="js/fireflower.js"></script>
    <script type="text/javascript" src="js/star.js"></script>
    <script type="text/javascript" src="js/fireball.js"></script>
    <script type="text/javascript" src="js/coin.js"></script>
    <script type="text/javascript" src="js/bcoin.js"></script>
    <script type="text/javascript" src="js/goomba.js"></script>
    <script type="text/javascript" src="js/koopa.js"></script>
    <script type="text/javascript" src="js/floor.js"></script>
    <script type="text/javascript" src="js/block.js"></script>
    <script type="text/javascript" src="js/rubble.js"></script>
    <script type="text/javascript" src="js/prop.js"></script>
    <script type="text/javascript" src="js/player.js"></script>
    <script type="text/javascript" src="js/flag.js"></script>
    <script type="text/javascript" src="js/levels/level.js"></script>
    <script type="text/javascript" src="js/levels/11.js"></script>
    <script type="text/javascript" src="js/levels/11tunnel.js"></script>
    <script type="text/javascript" src="js/game.js"></script>

    <script>
      function RockPaperScissors() {
        document.getElementById("mario").style.display = "none"
        document.getElementById("TicTacToe").style.display = "none"
        if ( document.getElementById("RockPaperScissors").style.display === "none") {
            document.getElementById("RockPaperScissors").style.display = "block";
        } else {
            document.getElementById("RockPaperScissors").style.display = "none";
        }
      }

      function TicTacToe() {
        document.getElementById("mario").style.display = "none"
        document.getElementById("RockPaperScissors").style.display = "none"
        if ( document.getElementById("TicTacToe").style.display === "none") {
            document.getElementById("TicTacToe").style.display = "block";
        } else {
            document.getElementById("TicTacToe").style.display = "none";
        }
      }

      function marioDisplay() {
        document.getElementById("TicTacToe").style.display = "none"
        document.getElementById("RockPaperScissors").style.display = "none"
        if ( document.getElementById("mario").style.display === "none") {
            document.getElementById("mario").style.display = "block";
        } else {
            document.getElementById("mario").style.display = "none";
        }
      }
    </script>

    <!-- Hello world! <br />
    This is the current date and time, as computed by Python: -->
    <!-- <py-config type="json">
      {
          "packages": ["numpy", "matplotlib"]
        }
    </py-config> -->


    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
